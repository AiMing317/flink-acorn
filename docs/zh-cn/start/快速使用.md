#### 插件安装

##### 下载插件

?> 如果github无法访问,建议使用gitee下载源码

```bash
git clone https://gitee.com/ispong/flink-acorn.git
# or
git clone https://github.com/ispong/flink-acorn.git
```

##### 修改插件配置文件

```bash
vim ${flink-acorn}/acorn-plugin/src/main/resources/application.yml 
```

```yaml
server:
  port: 30155 # 插件的端口号

acorn:
  plugin:
    log-dir: /home/acorn/log # 插件产生的日志路径
    tmp-dir: /home/acorn/tmp # 插件自动生成的项目临时路径
    server-key: acorn-key # 客户端需要使用到的密钥
    flink-port: 8081 # flink安装服务的端口号
    storage-tmp: false # 是否自动删除项目临时路径的文件
```

##### 打包编译

```bash
mvn clean package -f ${flink-acorn}/acorn-plugin/pom.xml
```

##### 运行插件

?> 建议不要直接使用java -jar运行

```bash
java -jar ${flink-acorn}/acorn-plugin/target/acorn-plugin.jar
# or
touch ${flink-acorn}/acorn.log
nohup java -jar -Xmx1024m ${flink-acorn}/acorn-plugin/target/acorn-plugin.jar >> ${flink-acorn}/acorn.log 2>&1 &
tail -f ${flink-acorn}/acorn.log
```

##### 关闭插件

```bash
sudo netstat -nlpt | grep 30155
sudo kill -9 ${pid}
```

#### 客户端使用

?> 建议参考 `${flink-acorn}/acorn-template` 这个项目

##### 添加项目依赖

```xml
<dependency>
    <groupId>com.isxcode.acorn</groupId>
    <artifactId>acorn-common</artifactId>
    <version>0.0.1</version>
</dependency>
```

!> 正式发布的版本比较慢，可使用紧急快照版本，需要提前指定镜像仓库

[查看可用快照版本](https://s01.oss.sonatype.org/content/repositories/snapshots/com/isxcode/acorn/acorn-common/)

```xml
<repository>
    <id>apache.snapshots.ossrh</id>
    <name>Apache Development Snapshot Repository OSSRH</name>
    <url>https://s01.oss.sonatype.org/content/repositories/snapshots/</url>
    <releases>
        <enabled>false</enabled>
    </releases>
    <snapshots>
        <enabled>true</enabled>
    </snapshots>
</repository>
```

```xml
<dependency>
    <groupId>com.isxcode.acorn</groupId>
    <artifactId>acorn-common</artifactId>
    <version>0.0.18-SNAPSHOT</version>
</dependency>
```

##### 修改客户端配置

```bash
vim ${flink-acorn}/acorn-template/src/main/resources/application.yml 
```

```yaml
acorn:
  node:
    host: ${plugin-host}
    port: 30155
    key: acorn-key
```

##### 使用acornTemplate

```java
package com.isxcode.acorn.template;

import com.isxcode.acorn.common.menu.TemplateType;
import com.isxcode.acorn.common.response.AcornResponse;
import com.isxcode.acorn.common.pojo.model.AcornModel1;
import com.isxcode.acorn.common.template.AcornTemplate;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RequestMapping
@SpringBootApplication
public class TemplateApplication {

    private final AcornTemplate acornTemplate;

    public TemplateApplication(AcornTemplate acornTemplate) {
        this.acornTemplate = acornTemplate;
    }

    public static void main(String[] args) {

        SpringApplication.run(TemplateApplication.class, args);
    }

    /**
     * 发布作业  返回jobId
     */
    @GetMapping("/execute")
    public String execute() {

        AcornModel1 acornModel1 = AcornModel1.builder()
            .jobName("job-name")
            .executeId("1314520")
            .fromConnectorSql("CREATE TABLE from_table ( ... ) WITH ( ... )")
            .toConnectorSql("CREATE TABLE to_table ( ... ) WITH ( ... )")
            .filterCode("Table fromData = fromData.select( ... )")
            .templateName(TemplateType.KAFKA_INPUT_KAFKA_OUTPUT)
            .build();

        AcornResponse acornResponse = acornTemplate.build().execute(acornModel1);
        return acornResponse.getAcornData().getJobId();
    }

    /**
     * 获取作业日志
     */
    @GetMapping("/getLog")
    public String getLog() {

        AcornResponse log = acornTemplate.build().getLog("1314520");
        return log.getAcornData().getJobLog();
    }

    /**
     * 获取作业运行状态
     */
    @GetMapping("/getJobStatus")
    public String getJobStatus() {

        AcornResponse jobInfo = acornTemplate.build().getJobInfo("jobId");
        return jobInfo.getAcornData().getJobInfo().getState();
    }

    /**
     * 停止作业
     */
    @GetMapping("/stopJob")
    public void stop() {

        acornTemplate.build().stopJob("jobId");
    }
}
```

##### 支持hive

```bash
vim /opt/flink/conf/hive-site.xml

# 重启flink

```
