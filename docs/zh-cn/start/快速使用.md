### 插件构建

?> 如果github无法访问,可使用gitee下载

```bash
# github下载地址
git clone https://github.com/ispong/flink-acorn.git
# gitee下载地址
git clone https://gitee.com/ispong/flink-acorn.git
```

###### 构建前提

- java 1.8+
- maven 3.0+

###### 开始构建

```bash
bash flink-acorn/build.sh
```

###### 配置系统环境变量

```bash
# 移动到指定目录
sudo mv acorn /opt/

# 修改环境变量
sudo vim /etc/profile
# === sudo vim /etc/profile ===
export FLINK_ACORN_HOME=/opt/acorn
export PATH=$PATH:$FLINK_ACORN_HOME/bin
# === sudo vim /etc/profile ===

# 环境变量生效
source /etc/profile
```

### 配置并启动插件

##### 修改插件配置文件

```bash
sudo vim /opt/conf/application-acorn.yml
```

```yaml
server:
  port: 30155

acorn:
  plugin:
    server-key: acorn-key
    flink-host: 127.0.0.1
    flink-port: 8081
    hive-conf-path: /opt/flink/conf
```

###### 运行插件

```bash
# 开启插件
sudo acorn-start.sh
# 关闭插件
sudo acorn-stop.sh
# 看日志
sudo acorn-log.sh
```

### 客户端插件使用

?> 建议参考 `acorn-template` 这个模块

##### 添加项目依赖

[![Maven Version](https://img.shields.io/maven-central/v/com.isxcode.acorn/acorn-common)](https://search.maven.org/artifact/com.isxcode.acorn/acorn-common)

```xml
<dependency>
    <groupId>com.isxcode.acorn</groupId>
    <artifactId>acorn-common</artifactId>
    <version>1.0.0</version>
</dependency>
```

!> 正式发布的版本比较慢，可使用紧急快照版本，配置指定镜像仓库

**查看可用快照版本**  [https://s01.oss.sonatype.org/content/repositories/snapshots/com/isxcode/acorn/acorn-common/](https://s01.oss.sonatype.org/content/repositories/snapshots/com/isxcode/acorn/acorn-common/)

```xml
<repository>
    <id>apache.snapshots.ossrh</id>
    <name>Apache Development Snapshot Repository OSSRH</name>
    <url>https://s01.oss.sonatype.org/content/repositories/snapshots/</url>
    <releases>
        <enabled>false</enabled>
    </releases>
    <snapshots>
        <enabled>true</enabled>
    </snapshots>
</repository>
```

```xml
<dependency>
    <groupId>com.isxcode.acorn</groupId>
    <artifactId>acorn-common</artifactId>
    <version>0.0.18-SNAPSHOT</version>
</dependency>
```

##### 修改客户端配置

```yaml
acorn:
  node:
    host: ${plugin-host}
    port: 30155
    key: acorn-key
```

##### 使用acornTemplate

```java
package com.isxcode.acorn.template.controller;

import com.isxcode.acorn.common.menu.TemplateType;
import com.isxcode.acorn.common.pojo.model.AcornModel1;
import com.isxcode.acorn.common.response.AcornResponse;
import com.isxcode.acorn.common.template.AcornTemplate;
import lombok.extern.slf4j.Slf4j;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

@Slf4j
@RestController
@RequestMapping
public class TestController {

    private final AcornTemplate acornTemplate;

    public TestController(AcornTemplate acornTemplate) {

        this.acornTemplate = acornTemplate;
    }

    @GetMapping("/execute")
    public void execute() {

        AcornModel1 acornModel1 = AcornModel1.builder()
            .jobName("ispong-test-flink-job")
            .executeId("1314520")
            .fromConnectorSql("CREATE TABLE from_table ( " +
                "  username STRING," +
                "  age INT " +
                ") WITH ( " +
                "  'scan.startup.mode'='latest-offset'," +
                "  'properties.group.id'='test-consumer-group'," +
                "  'connector'='kafka'," +
                "  'topic'='ispong_3'," +
                "  'properties.zookeeper.connect'='xxx.xxx.xxx.xxx:xxx'," +
                "  'properties.bootstrap.servers'='xxx.xxx.xxx.xxx:xxx'," +
                "  'format'='csv'," +
                "  'csv.ignore-parse-errors' = 'true')")
            .toConnectorSql("CREATE TABLE to_table ( " +
                "  username varchar(100)," +
                "  age int" +
                ") WITH (" +
                "  'connector'='jdbc'," +
                "  'url'='jdbc:mysql://xxx.xxx.xxx.xxx:xxx/xxx'," +
                "  'table-name'='ispong_flink_table'," +
                "  'driver'='com.mysql.cj.jdbc.Driver'," +
                "  'username'='xxx'," +
                "  'password'='xxx')")
            .filterCode("fromData = fromData.select($(\"username\").as(\"username\"),$(\"age\").as(\"age\"));")
            .templateName(TemplateType.KAFKA_INPUT_MYSQL_OUTPUT)
            .build();

        log.info(acornTemplate.build().execute(acornModel1).toString());
    }

    @GetMapping("/getLog")
    public void getLog() {

        AcornResponse flinkLog = acornTemplate.build().getJobLog("1314520");
        log.info(flinkLog.toString());
    }

    @GetMapping("/getJobStatus")
    public void getJobStatus(@RequestParam String jobId) {

        AcornResponse jobInfo = acornTemplate.build().getJobStatus(jobId);
        log.info(jobInfo.toString());
    }

    @GetMapping("/queryJobStatus")
    public void queryJobStatus() {

        AcornResponse jobInfo = acornTemplate.build().queryJobStatus();
        log.info(jobInfo.toString());
    }

    @GetMapping("/stopJob")
    public void stop() {

        AcornResponse jobId = acornTemplate.build().stopJob("jobId");
        log.info(jobId.toString());
    }
}
```
